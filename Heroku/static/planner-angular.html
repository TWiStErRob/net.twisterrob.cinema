<html lang="en" class="ui-stretch" ng-app="app">
<head>
<meta charset="utf-8">
<title>Cineworld Cinemas Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
	window.onerror = function() {
		window.error = arguments;
		var args = Array.prototype.slice.call(arguments);
		args.push("See window.error from console for more");
		alert(args.join("\n"));
	};
</script>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	<script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
<![endif]-->

<script src="/scripts/libs/jquery/jquery-1.10.2.js"></script>
<script src="/scripts/libs/angular/angular.js"></script>
<script src="/scripts/libs/angular/angular-animate.js"></script>
<script src="/scripts/libs/angular/angular-resource.js"></script>
<script src="/scripts/libs/angular/angular-route.js"></script>
<script src="/lib/bootstrap/bootstrap-3.0.3/js/bootstrap.js"></script>
<script src="/scripts/libs/angular/plugins/ui-bootstrap-tpls-0.9.0.js"></script>

<script src="/scripts/planner-angular/app.js"></script>
<script src="/scripts/planner-angular/utils.js"></script>
<script src="/scripts/planner-angular/controllers.js"></script>
<script src="/scripts/planner-angular/services/Cinema.js"></script>
<script src="/scripts/planner-angular/services/Film.js"></script>
<script src="/scripts/planner-angular/services/Performance.js"></script>
<script src="/scripts/planner-angular/services/Cineworld.js"></script>
<script src="/scripts/planner-angular/services/Status.js"></script>
<script src="/scripts/planner-angular/services/Planner.js"></script>
<script src="/scripts/planner-angular/filters.js"></script>
<script src="/scripts/planner-angular/directives.js"></script>
<script src="/scripts/planner-angular/animations.js"></script>

<script type="text/javascript" src="/scripts/libs/moment/moment-with-langs-2.4.0.js"></script>
<script type="text/javascript" src="/scripts/libs/moment/moment-range-0.1.9.js"></script>
<script type="text/javascript" src="/lib/utilities/lodash-2.4.1.js"></script>

<link href="/lib/bootstrap/bootstrap-3.0.3/css/bootstrap.css" rel="stylesheet" media="screen">
<link rel="stylesheet" type="text/css" href="/styles/planner-angular.css" />
</head>
<body class="ui-stretch" ng-controller="AppController">
	<section id="main" class="ui-stretch">
		<header id="date" ng-controller="DateController">
			<form name="cineworldDateForm" class="form-inline" role="form">
				<div class="form-group">
					<label for="cineworldDate">Date</label>
					<input id="cineworldDate" name="cineworldDate" type="text" ng-model="cineworld.date" class="form-control"
						datepicker-popup="shortDate" is-open="cineworldDatePickerDisplayed" />
				</div>
				<button class="btn btn-default" ng-click="displayCineworldDatePicker()">
					<i class="glyphicon glyphicon-calendar"></i>
				</button>
				Selected date is: <em>{{cineworld.date | date:'fullDate' }}</em>
			</div>
		</header>
		<aside id="debug" ng-controller="DebugController">
			<h6>Selected cinemas: {{(cineworld.cinemas | filter:{selected: true}).length}} / {{cineworld.cinemas.length}}</h6>
			<ul>
				<li ng-repeat="cinema in cineworld.cinemas | filter:{selected: true} | orderBy:'name'">
					<span class="cinema-name">{{cinema.name}}</span> (<span class="id">{{cinema.cineworldID}}</span>)
				</li>
			</ul>

			<h6>Selected films: {{(cineworld.films | filter:{selected: true}).length}} / {{cineworld.films.length}}</h6>
			<ul>
				<li ng-repeat="film in cineworld.films | filter:{selected: true} | orderBy:'title'">
					<span class="film-title">{{film.title}}</span> (<span class="id">{{film.edi}}</span>)
				</li>
			</ul>

			<h6>Combo</h6>
			<select ng-model="cinema" class="form-control" required ng-options="c.name group by !c.fav for c in cineworld.cinemas | orderBy:'name'">
				<option vlaue="">-- choose a cinema</option>
			</select>
		</aside>
		<section id="cinemas" class="ui-stretch" ng-controller="CinemasController">
			<script type="text/ng-template" id="cinema.shtml">
				<div class="checkbox">
					<i class="glyphicon pull-right" ng-class="{
						'loading'        : cinema.favLoading,
						'glyphicon-heart'     : cinema.fav,
						'glyphicon-star-empty': !cinema.fav
					}" ng-click="favClick(cinema)" />
					<label for="cinema-{{cinema.cineworldID}}" title="{{cinema | json}}">
						<input id="cinema-{{cinema.cineworldID}}" type="checkbox" class="check" value="{{cinema.cineworldID}}" ng-model="cinema.selected" />
						<span class="cinema-name">{{cinema.name}}</span>
					</label>
				</div>
			</script>
			<ul class="list-inline">
				<li ng-repeat="(id, button) in buttons" ng-hide="button.hidden">
					<button ng-click="buttonClick(button)" id="cinema-{{id}}" type="button" class="btn btn-primary btn-xs" ng-disabled="loading">{{button.label}}</button>
				</li>
			</ul>
			<accordion close-others="false" ng-init="isOpen_favs=true; isOpen_london=true" >
				<accordion-group is-open="isOpen_favs">
					<accordion-heading>
						Favorite cinemas ({{(cineworld.cinemas | filter:{fav: true}).length}})
						<i class="glyphicon pull-right" ng-class="{'glyphicon-chevron-down': isOpen_favs, 'glyphicon-chevron-right': !isOpen_favs}"></i>
					</accordion-heading>
					<div ng-show="loading">Loading cinemas...</div>
					<ul class="list-unstyled" ng-show="!loading">
						<li class="cinema" ng-repeat="cinema in cineworld.cinemas | filter:{fav: true} | orderBy:'name'" ng-include="'cinema.shtml'" />
					</ul>
				</accordion-group>
				<accordion-group is-open="isOpen_london">
					<accordion-heading>
						London cinemas ({{(cineworld.cinemas | filter:{name:'London'}).length}})
						<i class="glyphicon pull-right" ng-class="{'glyphicon-chevron-down': isOpen_london, 'glyphicon-chevron-right': !isOpen_london}"></i>
					</accordion-heading>
					<div ng-show="loading">Loading cinemas...</div>
					<ul class="list-unstyled" ng-show="!loading">
						<li class="cinema" ng-repeat="cinema in (cineworld.cinemas | filter:{name:'London'}) | orderBy:'name'" ng-include="'cinema.shtml'" />
					</ul>
				</accordion-group>
				<accordion-group is-open="isOpen_others">
					<accordion-heading>
						Other cinemas ({{(cineworld.cinemas | filter:{name:'!London'}).length}})
						<i class="glyphicon pull-right" ng-class="{'glyphicon-chevron-down': isOpen_others, 'glyphicon-chevron-right': !isOpen_others}"></i>
					</accordion-heading>
					<div ng-show="loading">Loading cinemas...</div>
					<ul class="list-unstyled" ng-show="!loading">
						<li class="cinema" ng-repeat="cinema in (cineworld.cinemas | filter:{name:'!London'}) | orderBy:'name'" ng-include="'cinema.shtml'" />
					</ul>
				</accordion-group>
			</accordion>
		</section>
		<section id="films" class="ui-stretch" ng-controller="FilmsController">
			<accordion close-others="false" ng-init="isOpen_films=true" >
				<accordion-group is-open="isOpen_films">
					<accordion-heading>
						Films ({{(cineworld.films).length}})
						<i class="glyphicon pull-right" ng-class="{'glyphicon-chevron-down': isOpen_films, 'glyphicon-chevron-right': !isOpen_films}"></i>
					</accordion-heading>
					<div ng-show="loading">Loading films...</div>
					<ul class="list-unstyled" ng-show="!loading">
						<script type="text/ng-template" id="viewPopup.shtml">
							<div class="modal-header">
								<h3>Edit view of <span class="film-tilte">{{selected.film.title}}</h3>
							</div>
							<div class="modal-body">
								<form novalidate name="viewForm" class="form-horizontal" role="form">
									<div class="form-group">
										<label class="col-sm-3 control-label film-title">Film</label>
										<div class="col-sm-9">
											<p class="form-control-static">{{selected.film.title}}</p>
										</div>
									</div>
									<div class="form-group">
										<label for="cinema" class="col-sm-3 control-label cinema-name">Cinema</label>
										<div class="col-sm-9">
											<select name="cinema" ng-model="selected.cinema" required class="form-control"
												ng-options="c.name group by cinemaGroup(c) for c in cinemas | orderBy:[cinemaGroup, 'name']"
												popover="Where did you watch this film." popover-trigger="focus" popover-placement="top">
											</select>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label time">Date</label>
										<div class="col-sm-9">
											<div class="input-group">
												<input id="date" name="date" type="text" ng-model="selected.date"
													class="form-control" datepicker-popup="shortDate" is-open="uiState.datePickerDisplayed" />
												<span class="input-group-btn">
													<button class="btn btn-default" type="button" ng-click="uiState.displayDatePicker()">
														<i class="glyphicon glyphicon-calendar"></i>&nbsp;
													</button>
												</span>
											</div>
											<!--<datepicker ng-model="selected.date" show-weeks="true"></datepicker>-->
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label time">Time</label>
										<div class="col-sm-9">
											<timepicker ng-model="selected.time" hour-step="1" minute-step="5" show-meridian="false"></timepicker>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label">Friends</label>
										<div class="col-sm-9">
											<div class="form-horizontal">
												<div class="form-group" ng-repeat="friend in selected.friends track by $index">
													<label for="friend-{{$index}}" title="{{friend}}" class="col-sm-3">Friend #{{$index+1}}</label>
													<div class="col-sm-9">
														<div class="input-group">
															<input id="friend-{{$index}}" type="text" class="form-control input-sm"
																	ng-model="selected.friends[$index]" />
															<span class="input-group-btn">
																<button class="btn btn-default btn-sm" type="button" title="Remove"
																		ng-click="selected.friends.splice($index, 1)">
																	<i class="glyphicon glyphicon-remove"></i>&nbsp;
																</button>
															</span>
														</div>
													</div>
												</div>
											</div>
											<div class="input-group">
												<input type="text" class="form-control" ng-model="newFriend"/>
												<span class="input-group-btn">
													<button class="btn btn-default" type="button" title="Add friend"
															ng-click="selected.friends.push(newFriend)">
														<i class="glyphicon glyphicon-plus"></i>
														<i class="glyphicon glyphicon-user"></i>
													</button>
												</span>
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-3 control-label">To recap</label>
										<div class="col-sm-9">
											<p class="form-control-static">you have
												watched <span class="film-title">{{selected.film.title}}</span>
												at <span class="cinema-name">{{selected.cinema.name}}</span>
												on <span class="time">{{selected.date | date:'shortDate'}}</span>
												at <span class="time">{{selected.time | date:'shortTime'}}</span>,
												<ng-pluralize count="selected.friends.length" offset="2"
													when="{
														'0': 'alone',
														'1': 'with {{selected.friends[0]}}',
														'2': 'with {{selected.friends[0]}} and {{selected.friends[1]}}',
														'one': 'with {{selected.friends[0]}}, {{selected.friends[1]}} and another friend',
														'other': 'with {{selected.friends[0]}}, {{selected.friends[1]}} and {} other friends'
													}"></ng-pluralize>.
											</p>
										</div>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button class="btn btn-success" ng-click="ok()">OK</button>
								<button class="btn btn-danger" ng-click="cancel()">Cancel</button>
							</div>
						</script>
						<li class="film" ng-repeat="film in cineworld.films | orderBy:['title']">
							<i class="glyphicon glyphicon-eye-open pull-right" ng-click="viewPopup(film)"></i>
							<span class="film-runtime pull-right" ng-show="film.runtime > 0">{{film.runtime}}</span>
							<div class="checkbox">
								<label for="film-{{film.edi}}" title="{{film | json}}">
									<input id="film-{{film.edi}}" type="checkbox" class="check" value="{{film.edi}}" ng-model="film.selected" />
									<span class="film-title">{{film.title}}</span>
								</label>
							</div>
						</li>
					</ul>
				</accordion-group>
			</accordion>
		</section>
		<section id="performances" class="ui-stretch" ng-controller="PerformancesController">
			<div ng-show="loading">Loading performances...</div>
			<table ng-show="!loading">
				<thead>
					<tr>
						<th class="cinema">Cinema</th>
						<th class="film" ng-repeat="film in cineworld.films | filter: {selected: true}" title="{{film | json}}">
							<span class="film-title">{{film.title}}</span>
							<span ng-show="film.runtime > 0" class="film-runtime">{{film.runtime}}</span>
						</th>
					</tr>
				</thead>
				<tbody>
					<tr ng-repeat="cinema in cineworld.cinemas | filter: {selected: true}">
						<td class="cinema" title="{{cinema | json}}">
							<a href="http://maps.google.com/?q={{cinema.postcode}}" title="{{cinema.postcode}}" class="glyphicon glyphicon-globe pull-right"></a>
							<span class="cinema-name">{{cleanName(cinema.name)}}</span>
						 </td>
						<td class="performances" ng-repeat="film in cineworld.films | filter: {selected: true}" title="{{performances[cinema.cineworldID][film.edi] | json}}">
							<span ng-repeat="performance in performances[cinema.cineworldID][film.edi]"><a href="{{performance.booking_url}}" class="time" title="{{performance | json}}">{{performance.time}}</a>{{$last? "" : ","}}</span>
						</td>
					</tr>
				</tbody>
			</table>
			<accordion id="plan-results" ng-show="!loading" close-others="false">
				<script type="text/ng-template" id="plan.shtml">
					<span class="plan-header">
						<span class="film-start">{{plan.range.start | moment:'format':'HH:mm'}}</span>&mdash;<span class="film-end">{{plan.range.end | moment:'format':'HH:mm'}}</span>
						(<span title="{{plan.offenses | json}}">offends: {{plan.offenses.count}}-&gt;{{offensePriority(plan)}}</span>)
					</span>
					<ol>
						<li ng-repeat-start="movie in plan" ng-if="movie.breakBefore" value="{{$index}}" style="list-style-type: none">
							<span class="length">{{movie.breakBefore}}</span> minutes break
						</li>
						<li ng-repeat-end title="{{movie | json}}">
							<span class="film-start">{{movie.range.start | moment:'format':'HH:mm'}}</span>&mdash;<span class="film-end">{{movie.range.end | moment:'format':'HH:mm'}}</span>
							<span class="film-runtime">{{movie.film().runtime}}</span>:
							<span class="film-title">{{movie.film().title}}</span>
						</li>
					</ol>
				</script>
				<accordion-group ng-repeat="cinemaPlan in plans" is-open="cinemaPlan.display">
					<accordion-heading>
						<span class="cinema-name">{{cinemaPlan.cinema.name}}</span>
						(<ng-pluralize count="cinemaPlan.valid.length"
							when="{
								'0': 'no plans',
								'one': '1 plan',
								'other': '{} plans'
							}"></ng-pluralize>
						and
						<ng-pluralize count="cinemaPlan.offending.length"
							when="{
								'0': 'no suggestions',
								'one': '1 suggestion',
								'other': '{} suggestions'
							}"></ng-pluralize>)
						<i class="glyphicon pull-right" ng-class="{'glyphicon-chevron-down': cinemaPlan.display, 'glyphicon-chevron-right': !cinemaPlan.display}"></i>
					</accordion-heading>
					<ul>
						<li ng-include="'plan.shtml'" ng-repeat="plan in cinemaPlan.valid" />
						<li ng-include="'plan.shtml'" ng-repeat="plan in cinemaPlan.offending | orderBy:[offenseCount, offensePriority]" />
					</ul>
				</accordion-group>
			</accordion>
		</section>
	</section>
	<div id="statusmessage" ng-show="stati.length > 0" ng-controller="StatusController">
		<div ng-repeat="status in stati track by $index">{{status}}</div>
	</div>
</body>
</html>
