name: Release to Google App Engine
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for release'
        required: false
        default: 'Publish latest changes'
      production:
        description: 'Deploy to production?'
        required: true
        default: false
        type: boolean
jobs:
  release:
    name: Release to Google App Engine (${{ github.event.inputs.reason }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      REF_TO_RELEASE: ${{ github.ref }}
      RELEASE_TO_PRODUCTION: ${{ github.event.inputs.production || github.ref == 'refs/heads/master' }}
    permissions:
      contents: read  # This is required for actions/checkout.
      # https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#updating-your-actions-for-oidc
      id-token: write # This is required for requesting the JWT via google-github-actions/auth.
    steps:
      - uses: actions/github-script@v6
        with:
          script: |
            const ref = process.env.REF_TO_RELEASE
            const ver = ref == 'refs/heads/master'
              ? 'master'
              // ERROR: (gcloud.app.deploy) argument --version/-v: Bad value [...]:
              // May only contain lowercase letters, digits, and hyphens.
              // Must begin and end with a letter or digit. Must not exceed 63 characters.
              : ref.replace('refs/heads/', 'pr-').replace(/[^a-z0-9-]/g, '-')
            core.exportVariable('RELEASE_VERSION', ver)
        # output: env.RELEASE_VERSION

      - name: Checkout ${{ env.REF_TO_RELEASE }} branch in ${{ github.repository }} repository.
        uses: actions/checkout@v3
        with:
          ref: ${{ env.REF_TO_RELEASE }}

      - name: Validate Gradle Wrapper JARs.
        uses: gradle/wrapper-validation-action@v1

      - name: Authenticate to Google Cloud.
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GAE_WIP }}
          service_account: ${{ secrets.GAE_SA }}
      - name: Print tooling versions.
        run: |
          node -v
          npm -v
          java -version
          gcloud --version

      - name: Build Frontend.
        working-directory: Heroku
        env:
          NODE_ENV: production
          # Install `devDependencies`, so `npm build` runs `webpack` correctly.
          NPM_CONFIG_PRODUCTION: false
        run: |
          npm install
          cd frontend
          npm run build:prod

      - name: Build Backend.
        working-directory: Heroku
        run: >
          ./gradlew
          :backend:endpoint:jar

      - name: Publish ${{ env.RELEASE_VERSION }} to Google App Engine (production=${{ env.RELEASE_TO_PRODUCTION }}.
        working-directory: Heroku
        env:
          # Use pre-existing SDK, don't download a new one.
          GCLOUD_HOME: /usr/lib/google-cloud-sdk
          # Will be propagated to app.yml
          NEO4J_URL: ${{ secrets.NEO4J_URL }}
        run: >
          ./gradlew
          :deploy:appengine:appengineDeploy
          -Pnet.twisterrob.build.deployReplaceLive=${{ env.RELEASE_TO_PRODUCTION }}
          -Pnet.twisterrob.build.deployName=${{ env.RELEASE_VERSION }}
